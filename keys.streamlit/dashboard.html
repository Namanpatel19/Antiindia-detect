<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Detection Dashboard</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="topbar">
    <div class="container">
      <h1>Detection Dashboard — Prototype</h1>
      <p class="subtitle">Rendered client-side. This is a read-only view of the analysis results.</p>
    </div>
  </header>

  <main class="container grid">
    <section class="cards">
      <div class="card" id="card-low">
        <h3>Low Risk</h3>
        <p class="big" id="count-low">0</p>
      </div>
      <div class="card" id="card-med">
        <h3>Medium Risk</h3>
        <p class="big" id="count-med">0</p>
      </div>
      <div class="card" id="card-high">
        <h3>High Risk</h3>
        <p class="big" id="count-high">0</p>
      </div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <h2>Top flagged posts</h2>
        <div class="controls">
          <label>Min risk:
            <input id="risk-filter" type="range" min="0" max="1" step="0.01" value="0">
            <span id="risk-val">0.00</span>
          </label>
          <input id="search" placeholder="Search text / username" />
        </div>
      </div>
      <div class="table-wrap">
        <table id="posts-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Platform</th>
              <th>Username</th>
              <th>Text</th>
              <th>Keywords</th>
              <th>Risk</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <h2>Hashtags / Top tags</h2>
      </div>
      <div id="tag-list" class="tag-list"></div>
    </section>

    <section class="panel" id="raw-json-panel">
      <div class="panel-head">
        <h2>Raw JSON (preview)</h2>
      </div>
      <pre id="raw-json"></pre>
    </section>
  </main>

  <footer class="container footer">
    <small>For testing & development only. Do not use with real user data without consent.</small>
  </footer>

  <script>
    // Replace this placeholder by your Python code before rendering.
    // The Python code should read the file and do: html = html.replace("{{DATA}}", json.dumps(records))
    // Example: records = df.to_dict(orient="records")
    const DATA = {{DATA}};

    // Utility: safe text truncate
    function ellipsize(s, n=140){ return s && s.length>n ? s.slice(0,n-1) + "…" : (s||""); }

    // Prepare dataset fields fallback
    const rows = (Array.isArray(DATA) ? DATA : []);
    // compute counts
    let low=0, med=0, high=0;
    const tags = {};
    rows.forEach(r=>{
      const risk = typeof r.risk === "number" ? r.risk : parseFloat(r.risk || 0);
      if (risk < 0.2) low++;
      else if (risk < 0.6) med++;
      else high++;
      // collect hashtags
      const t = r.keyword_hits || r.keyword_hits || [];
      if (Array.isArray(t)){
        t.forEach(tt=>{
          tags[tt] = (tags[tt]||0)+1;
        });
      } else if (typeof t === "string" && t.trim()){
        tags[t] = (tags[t]||0)+1;
      }
    });

    document.getElementById("count-low").textContent = low;
    document.getElementById("count-med").textContent = med;
    document.getElementById("count-high").textContent = high;

    const tbody = document.querySelector("#posts-table tbody");
    function renderTable(filterRisk=0, search=""){
      tbody.innerHTML = "";
      const q = search.trim().toLowerCase();
      const filtered = rows.filter((r,i)=>{
        const risk = typeof r.risk === "number" ? r.risk : parseFloat(r.risk || 0);
        if (risk < filterRisk) return false;
        if (!q) return true;
        const fields = [
          r.text||"",
          r.username||"",
          (r.keyword_hits||[]).join(" ")
        ].join(" ").toLowerCase();
        return fields.indexOf(q) !== -1;
      });
      filtered.slice(0,200).forEach((r,i)=>{
        const tr = document.createElement("tr");
        const platform = r.platform||"-";
        const username = r.username||"-";
        const text = ellipsize(r.text||"", 220);
        const kws = (Array.isArray(r.keyword_hits) ? r.keyword_hits.join(", ") : (r.keyword_hits||"-"));
        const risk = (typeof r.risk === "number" ? r.risk : parseFloat(r.risk||0)).toFixed(3);
        tr.innerHTML = `<td>${i+1}</td><td>${platform}</td><td>${username}</td>
                        <td title="${(r.text||"").replace(/"/g,'&quot;')}">${text}</td>
                        <td>${kws}</td><td>${risk}</td>`;
        tbody.appendChild(tr);
      });
    }

    // render tags
    const tagList = document.getElementById("tag-list");
    const tagEntries = Object.entries(tags).sort((a,b)=>b[1]-a[1]).slice(0,40);
    tagEntries.forEach(([t,c])=>{
      const el = document.createElement("div");
      el.className = "tag";
      el.textContent = `${t} — ${c}`;
      tagList.appendChild(el);
    });

    // initial table
    renderTable(0,"");

    // search & risk filter
    const riskInput = document.getElementById("risk-filter");
    const riskVal = document.getElementById("risk-val");
    const searchInput = document.getElementById("search");

    riskInput.addEventListener("input", ()=>{
      const v = parseFloat(riskInput.value);
      riskVal.textContent = v.toFixed(2);
      renderTable(v, searchInput.value);
    });
    searchInput.addEventListener("input", ()=>{
      renderTable(parseFloat(riskInput.value), searchInput.value);
    });

    // raw JSON preview
    document.getElementById("raw-json").textContent = JSON.stringify(rows.slice(0,200), null, 2);
  </script>
</body>
</html>
